trigger:
- main

stages:
# ================= Build Stage =================
- stage: Build
  displayName: Terraform Build
  jobs:
  - job: Build
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      displayName: Install Terraform
      inputs:
        terraformVersion: '1.3.10'

    - task: TerraformTask@5
      displayName: Terraform Validate
      inputs:
        provider: azurerm
        command: validate

    - task: TerraformTask@5
      displayName: Terraform Format
      inputs:
        provider: azurerm
        command: custom
        customCommand: fmt
        outputTo: console
        environmentServiceNameAzureRM: Billing-Subscription(af504235-2f6d-4469-aa25-251f498730fc)

# ================= Deploy Stage =================
- stage: Deploy
  displayName: Terraform Deploy
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: Deploy
    displayName: Deploy Azure Resources
    environment: dev  # Optional: approval can be added
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          - task: TerraformInstaller@1
            displayName: Install Terraform
            inputs:
              terraformVersion: '1.3.10'

          - task: TerraformTask@5
            displayName: Terraform Init
            inputs:
              provider: azurerm
              command: init
              backendServiceArm: Billing-Subscription(af504235-2f6d-4469-aa25-251f498730fc)
              backendAzureRmStorageAccountName: azdevopsvenkat
              backendAzureRmContainerName: terraform
              backendAzureRmKey: terraform.tfstate

          - task: TerraformTask@5
            displayName: Terraform Plan
            inputs:
              provider: azurerm
              command: plan
              commandOptions: '-out=tfplan'
              environmentServiceNameAzureRM: Billing-Subscription(af504235-2f6d-4469-aa25-251f498730fc)

          - task: TerraformTask@5
            displayName: Terraform Apply
            inputs:
              provider: azurerm
              command: apply
              commandOptions: 'tfplan'
              environmentServiceNameAzureRM: Billing-Subscription(af504235-2f6d-4469-aa25-251f498730fc)

# ================= Destroy Stage =================
- stage: Destroy
  displayName: Terraform Destroy
  dependsOn: Deploy
  condition: succeeded()
  jobs:
  - deployment: Destroy
    displayName: Destroy Azure Resources
    environment: prod  # Requires manual approval
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          - task: TerraformInstaller@1
            displayName: Install Terraform
            inputs:
              terraformVersion: '1.3.10'

          - task: TerraformTask@5
            displayName: Terraform Init
            inputs:
              provider: azurerm
              command: init
              backendServiceArm: Billing-Subscription(af504235-2f6d-4469-aa25-251f498730fc)
              backendAzureRmStorageAccountName: azdevopsvenkat
              backendAzureRmContainerName: terraform
              backendAzureRmKey: terraform.tfstate

          - task: TerraformTask@5
            displayName: Terraform Destroy
            inputs:
              provider: azurerm
              command: destroy
              commandOptions: '-auto-approve'
              environmentServiceNameAzureRM: Billing-Subscription(af504235-2f6d-4469-aa25-251f498730fc)
